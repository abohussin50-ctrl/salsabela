<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Salsabela ‚Äî Adhkar</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&family=Amiri&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f8fafb;
      color: #222;
      margin: 0;
      padding: 1rem;
    }
    main {
      max-width: 900px;
      margin: auto;
      position: relative;
    }
    h2 {
      color: #2a9d8f;
      text-align: center;
      margin-bottom: 1rem;
    }
    .section-card {
      background: #fff;
      border-radius: 10px;
      padding: 12px 15px;
      margin-bottom: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: 0.3s;
    }
    .section-card:hover { background: #e8f7f4; }
    .zekr {
      background: #fff;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .arabic {
      font-family: 'Amiri', serif;
      font-size: 1.2rem;
      color: #000;
      direction: rtl;
      text-align: right;
      margin-bottom: 8px;
    }
    .translation {
      color: #444;
      font-size: 0.95rem;
      border-top: 1px solid #eee;
      padding-top: 6px;
    }
    .back-btn {
      display: inline-block;
      background: #2a9d8f;
      color: #fff;
      padding: 8px 14px;
      border-radius: 8px;
      text-decoration: none;
      margin-bottom: 15px;
      cursor: pointer;
      transition: 0.3s;
    }
    .back-btn:hover { background: #24897f; }
    audio { width: 100%; margin-top: 8px; }
    #searchBox {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      font-family: 'Cairo', sans-serif;
      font-size: 1rem;
      position: relative;
    }
    .suggestions {
      position: absolute;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      max-height: 220px;
      overflow-y: auto;
      z-index: 1000;
      width: 100%;
      display: none;
    }
    .suggestions div {
      padding: 8px 12px;
      cursor: pointer;
      transition: 0.2s;
    }
    .suggestions div:hover {
      background: #e8f7f4;
    }
    .counter-btn {
      background: #2a9d8f;
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
    }
    .counter-btn:hover {
      background: #24897f;
    }
    .counter {
      color: #555;
      margin-top: 6px;
    }
  </style>
</head>
<body>
<div id="header-holder"></div>
<main>
  <h2>Adhkar</h2>
  <div style="position: relative;">
    <input type="search" id="searchBox" placeholder="üîç Search by Arabic or English..." autocomplete="off">
    <div id="suggestions" class="suggestions"></div>
  </div>
  <div id="content">Loading...</div>
</main>
<div id="footer-holder"></div>

<script src="js/common.js"></script>
<script>
const content = document.getElementById("content");
const searchBox = document.getElementById("searchBox");
const suggestionBox = document.getElementById("suggestions");
let allData = [];

// üîπ Normalize Arabic text
function normalizeText(text) {
  return text
    .toLowerCase()
    .replace(/[ŸéŸãŸèŸåŸêŸçŸíŸëŸÄÿåÿõÿü]/g, "")
    .replace(/[ÿ£ÿ•ÿ¢Ÿ±]/g, "ÿß")
    .replace(/ÿ§/g, "Ÿà")
    .replace(/ÿ¶/g, "Ÿä")
    .replace(/ÿ©/g, "Ÿá")
    .replace(/Ÿâ/g, "Ÿä")
    .replace(/[^a-zÿ°-Ÿä0-9\s]/gi, " ")
    .trim();
}

// üîπ Load JSON
async function loadAdhkar() {
  try {
    const res = await fetch("source/husn_en.json");
    const data = await res.json();
    allData = data.English;
    renderSections();
  } catch (err) {
    content.innerHTML = `<p style="color:red;text-align:center">‚ö†Ô∏è Error loading adhkar file.</p>`;
  }
}

// üîπ Render sections
function renderSections() {
  suggestionBox.style.display = "none";
  content.innerHTML = "";
  allData.forEach((sec, i) => {
    const div = document.createElement("div");
    div.className = "section-card";
    div.textContent = sec.TITLE;
    div.onclick = () => renderAdhkar(i);
    content.appendChild(div);
  });
}

// üîπ Render adhkar of section
function renderAdhkar(index) {
  const sec = allData[index];
  content.innerHTML = `
    <div class="back-btn" onclick="renderSections()">‚Üê Back</div>
    <h2>${sec.TITLE}</h2>
  `;

  const saved = JSON.parse(localStorage.getItem("salsabeela-adhkar") || "{}");

  sec.TEXT.forEach(z => {
    const id = z.ID;
    const current = saved[id] ?? z.REPEAT ?? 1;
    const div = document.createElement("div");
    div.className = "zekr";
    div.innerHTML = `
      <div class="arabic">${z.ARABIC_TEXT || ''}</div>
      <div class="translation">${z.TRANSLATED_TEXT || ''}</div>
      ${z.REPEAT ? `<div class="counter">üîÅ Repeat: <span id="cnt-${id}">${current}</span></div>
      <button class="counter-btn" data-id="${id}" data-repeat="${z.REPEAT}">Tap</button>` : ''}
      ${z.AUDIO ? `<audio controls src="${z.AUDIO}"></audio>` : ''}
    `;
    content.appendChild(div);
  });

  document.querySelectorAll(".counter-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-id");
      const span = document.getElementById("cnt-" + id);
      let val = parseInt(span.textContent);
      if (val > 0) val--;
      span.textContent = val;

      const store = JSON.parse(localStorage.getItem("salsabeela-adhkar") || "{}");
      store[id] = val;
      localStorage.setItem("salsabeela-adhkar", JSON.stringify(store));
    });
  });
}

// üîπ Smart search
searchBox.addEventListener("input", () => {
  const query = normalizeText(searchBox.value);
  suggestionBox.innerHTML = "";
  if (!query) { suggestionBox.style.display = "none"; renderSections(); return; }

  const matches = [];
  allData.forEach((sec, idx) => {
    const title = normalizeText(sec.TITLE);
    if (title.includes(query)) matches.push({ name: sec.TITLE, index: idx });
    sec.TEXT.forEach(t => {
      const ar = normalizeText(t.ARABIC_TEXT || "");
      const en = normalizeText(t.TRANSLATED_TEXT || "");
      if (ar.includes(query) || en.includes(query)) matches.push({ name: sec.TITLE, index: idx });
    });
  });

  suggestionBox.innerHTML = "";
  matches.slice(0, 8).forEach(m => {
    const item = document.createElement("div");
    item.textContent = m.name;
    item.onclick = () => {
      suggestionBox.style.display = "none";
      searchBox.value = m.name;
      renderAdhkar(m.index);
    };
    suggestionBox.appendChild(item);
  });
  suggestionBox.style.display = matches.length ? "block" : "none";
});

// Hide suggestions when unfocused
searchBox.addEventListener("blur", () => {
  setTimeout(() => suggestionBox.style.display = "none", 200);
});

loadAdhkar();
</script>
</body>
</html>
